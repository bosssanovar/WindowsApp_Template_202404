# 基礎設計

## 1. 概要

製品仕様に大きく影響されない、設定用PCアプリケーションに共通的な部分に関する基礎設計を示す。

## 2. 要点

設計の要点は以下の通り。  

- オニオンアーキテクチャに沿ってモジュール分割することで、実装箇所の明確化、＊＊＊＊、＊＊＊＊を実現している。
- 高凝集・疎結合にモジュールが分割されていることから、モジュールごとにテストコードやテストアプリが作りやすく、他モジュールの進捗に依存せずにモジュール単位での機能作り込みが可能。
- ＊＊＊＊＊＊＊＊＊＊＊＊＊
- ＊＊＊＊＊＊＊＊＊＊＊＊＊
- ＊＊＊＊＊＊＊＊＊＊＊＊＊

## 3. システム要素

システムで採用している要素片（設計パターン、ライブラリ、etc.）は以下の通り。  

- ドメイン知識  
;asjd;fkja;skdfj;askdfja;

- ドメインロジック  
afjksldfj;aksdjf;aksdjf;

- オニオンアーキテクチャ  
aaaaaaaaasdfkjal;skdfj;aksjdf  

- MVVM  
aaaaaaaaasdfkjal;skdfj;aksjdf  

- ReactiveProperty  
alks;djf;aksdj;fkasjdf;akj  

- Value Object  
kajlsdj;fkj;askjdf;as

- Entity  
kajlsdj;fkj;askjdf;as

- Behavior  
kajlsdj;fkj;askjdf;as

- DI (Dependency Injection)  
kajlsdj;fkj;askjdf;as

- DIコンテナ  
；ぁｋｓｄ；ｆｋｊ；あｓｋｊｄふぁ

## 4. アーキテクチャ設計

PCアプリケーションを設計する上で、守備範囲の異なる「システムアーキテクチャ」と「GUIアーキテクチャ」のそれぞれの視点での設計を示す。

>システムアーキテクチャとは "GUI"アーキテクチャの汎用性を増したもの。  
さらに詳しくいうと、"システム"アーキテクチャは、"GUI"アーキテクチャよりも広い、UIという単位にとらわれることなくシステム全体の構造を示せるもの。
「システムアーキテクチャ > GUIアーキテクチャ」  

>GUIアーキテクチャは、Viewからの視点で、構造化設計を実践する際の具体的なレイヤー構造をパターンとして示したもの。  

＊＊＊＊＊＊＊＊＊＊＊＊＊＊構造図＊＊＊＊＊＊＊＊＊＊＊＊

## 5. システムアーキテクチャ設計

本章では、GUIアーキテクチャ範囲を除外したシステムアーキテクチャの設計を示す。

### 5.1. システムアーキテクチャ　レイヤー設計

オニオンアーキテクチャの考え方に沿ったレイヤー設計として、以下のレイヤー分割を行った。

- Domain Model層
- Domain Service層
- Application Service層
- Infrastructure層
- User Interface層

＊＊＊＊＊＊＊＊玉ねぎの図＊＊＊＊＊＊＊＊＊

各層の機能概要を以下に示す。

#### 5.1.1. Domain Model層

- ビジネスドメインのコアロジックやビジネスルールを表現する。
- ドメインモデルはエンティティ、バリューオブジェクトなどで構成され、ビジネスオブジェクトとその振る舞いを表現する。

#### 5.1.2. Domain Service層

- ドメインモデルが持つ責務の一部を凝集させている
- ドメインモデルに直接関連する操作や、複数のドメインオブジェクトにまたがる操作を提供
- ドメインサービスは、ビジネスルールやビジネスロジックの実装を含む場合があり、ドメインモデルの一部として表現されることもある

#### 5.1.3. Application Service層

- アプリケーションの振る舞いを実装
- ユーザーインターフェースや外部APIとのやり取りを処理し、ビジネスロジックの組み立てやドメインモデルへの操作を行う
- アプリケーションサービスは、ドメインモデルの操作の組み合わせによってユースケースを実現する。
トランザクションの管理やエラーハンドリングも担当

#### 5.1.4. Infrastructure層

- データベース、キャッシング、外部サービス、ログ出力、メッセージングなど、外部要素とのやり取りを担当
- データの永続化や取得、外部サービスへのリクエストなど、ドメインモデルやアプリケーションサービスの要求を満たす役割

#### 5.1.5. User Interface層

GUIアーキテクチャの守備範囲のため、後述する。

### 5.2. システムアーキテクチャ　コンポーネント設計

前述の各層の中に、それぞれの機能が凝集されたコンポーネントを配置する。

＊＊＊＊＊＊＊＊＊＊＊＊＊コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊

各層の各コンポーネントの詳細は以下に示す。

#### 5.2.1. Domain Model層コンポーネント

＊＊＊＊＊＊＊＊＊＊抜粋コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

Domain Model層のコンポーネント概要を以下に示す。

##### 5.2.1.1. 各種Entity

機能まとまり単位の設定値クラス群（Value Object）とその集約（EEntity）、またそれらの制限機能を配置するコンポーネント。  
設定値のインポート/エクスポートのためのプリミティブなデータのみを抱える小袋クラス（Data Packet）も定義する。

##### 5.2.1.2. Domain Model Common

各Entityが参照するValue Objectの基底クラスや、プリミティブ型の拡張機能クラス等の基底機能を配置するコンポーネント。

#### 5.2.2. Domain Service層コンポーネント

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊抜粋コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

Domain Service層のコンポーネント概要を以下に示す。

##### 5.2.2.1. Domain Service

Domain Model層の各Entityを跨いだ処理クラスを格納するコンポーネント。

ex.  
２つのEntityがあると仮定して、一方のEntity内の設定値が変更された際に、その変更に応じてもう一方のEntity内の設定値を自動変更する処理。

##### 5.2.2.2. Repository

Entityのインスタンスを取得・格納するリポジトリのインターフェースを格納するコンポーネント。  
リポジトリインターフェースの実装クラスはInfrastructure層に配置される。

#### 5.2.3. Application Service層コンポーネント

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊抜粋コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

Application Service層のコンポーネント概要を以下に示す。

##### 5.2.3.1. Usecase

アプリケーションのユースケース単位で、ドメインロジックやインフラ機能を利用して機能を実現するクラスを配置するコンポーネント。

ex.  
Domain Service層のRepositoryから設定値を取得して、Featureコンポーネントのデータファイルクラスに設定データファイルの保存を依頼する、「データを保存する」ユースケースクラス。

##### 5.2.3.2. Feature

Domain Model層のドメインデータをプリミティブ型のデータに変換、もしくはその逆の変換を行い、Infrastructure層の外部依存機能を利用する機能クラスを格納するコンポーネント。

ex.  
Domain Service層のRepositoryから取得された設定値インスタンス群を外部データ仕様に沿った形式（ex. json）に変換して、Infrastructure層のデータファイル保存クラスにファイル保存を依頼する、「データファイルアクセス」クラス。

#### 5.2.4. Infrastructure層コンポーネント

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊抜粋コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

Infrastructure層のコンポーネント概要を以下に示す。

##### 5.2.4.1. File Accessor

Application Service層からの依頼を受けて、各種ファイルを生成しストレージに保存する機能クラスを配置するコンポーネント。
ファイルの暗号化や一定期間区切りのログファイル生成、Excelデータ操作ライブラリを利用したデータのエクスポートなど、ドメインロジックに含まれない非機能要求を実現するための実装等も配置される。

##### 5.2.4.2. In Memory Repository

Domain Service層のRespositoryコンポーネントで定義したインターフェースを実現するクラスを配置するコンポーネント。  
オニオンアーキテクチャの基礎的な実現方法について書かれたウェブ記事などでは、このコンポーネントはデータベースアクセスを実装するものとなっており、複合的なテーブル操作の知識を実装するためのコンポーネントとされている。  
本設計においては、データベースを利用しない予定となっているため、メモリ上にEntityオブジェクトを保持して、そのオブジェクトを提供・上書き保存する機能のみを有する。

#### 5.2.5. User Interface層コンポーネント

GUIアーキテクチャの守備範囲のため、後述する。

### 5.3. システムアーキテクチャ　ユースケース

各層のコラボレーションについての理解を促すため、Application Service層のUsecaseコンポーネントで実現する各種ユースケースのアクティビティ図を以下に示す。

#### 5.3.1. 設定値表示

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊アクティビティ図＊＊＊＊＊＊＊＊＊＊＊＊

＊＊＊＊＊＊一部、詳細説明＊＊＊＊＊＊＊

#### 5.3.2. 設定値確定

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊アクティビティ図＊＊＊＊＊＊＊＊＊＊＊＊

＊＊＊＊＊＊一部、詳細説明＊＊＊＊＊＊＊

#### 5.3.3. 設定データ保存

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊アクティビティ図＊＊＊＊＊＊＊＊＊＊＊＊

＊＊＊＊＊＊一部、詳細説明＊＊＊＊＊＊＊

#### 5.3.4. 設定データ読み込み

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊アクティビティ図＊＊＊＊＊＊＊＊＊＊＊＊

＊＊＊＊＊＊一部、詳細説明＊＊＊＊＊＊＊

#### 5.3.5. 設定値初期化

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊アクティビティ図＊＊＊＊＊＊＊＊＊＊＊＊

＊＊＊＊＊＊一部、詳細説明＊＊＊＊＊＊＊

## 6. GUIアーキテクチャ設計

本章では、システムアーキテクチャ章で除外した、GUIアーキテクチャ部であるUser interface層の設計を示す。

### 6.1. GUIアーキテクチャ（User interface層）　レイヤー設計

MVVMの考え方に沿ったレイヤー設計として、以下のレイヤー分割を行った。

- Model
- View
- View Model

＊＊＊＊＊＊＊＊MVVM、バインドの図＊＊＊＊＊＊＊＊＊

各層の機能概要を以下に示す。

#### 6.1.1. Model層

広義のModel層は、アプリケーションのドメイン知識を担う、そのアプリケーションが扱う領域のデータと手続きを表現する要素を配置する層。  
UI知識を一切含めない。

ex.  
ショッピングの合計額や送料を計算する。

本設計においては、ドメイン知識はシステムアーキテクチャとして各層に高凝集に配置されており、既に必要な機能はそちらで実現されているため、Model層の責務は以下のものに限られる。

- 画面に表示される設定値を集約するEntityを画面内テンポラリとして保持する。
- ユースケースに応じた処理は、Application Service層のUsecaseコンポーネントに処理を委譲する。

#### 6.1.2. View層

アプリケーションの扱うデータをユーザーが見るのに適した形で表示し、ユーザーからの入力を受け取る要素を配置する層。  
ドメイン知識を一切含めない。

ex.  

- 画面レイアウト、デザイン
- アニメーション
- 入力文字制限

#### 6.1.3. ViewModel層

Model層とView層との中間層。  
ViewとModelの間の情報の伝達（変換）と、Viewのための状態保持のみを役割とする要素を配置する層。  

ex.  
チェックボックス設定項目 AAA, BBB, CCCが全てチェックされた場合のみ、あるUI要素がEnableになる。

```c#
class Model{
    public bool Aaa;
    public bool Bbb;
    public bool Ccc;
}

class ViewModel{
    Model model;
    public bool IsEnabled
    {
        get
        {
            return model.Aaa && model.Bbb && model.Ccc; //※ここ
        }
    }
}
```

### 6.2. User interface層　コンポーネント設計

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊抜粋コンポーネント図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

User interface層のコンポーネント概要を以下に示す。

#### 6.2.1. スタートプロジェクト(WpfApp1)

アプリケーションのエントリーポイントクラスを格納するコンポーネント。  
アプリケーション起動時/終了時シーケンスを実装する。

アプリケーション起動時処理として、DIコンテナのサービス構築を行う。

#### 6.2.2. WPF Library

BehaviorやIConverterの実装、WPFコントロールの機能拡張など、WPFを拡張する機能クラスを格納するコンポーネント。  
GUIアーキテクチャのViewに関わる機能のみ。

#### 6.2.3. UI Parts

各画面のMVVMクラス、画面に配置するUser Control等のUI画面とその部品、そしてそれらのデザインリソースを格納するコンポーネント。

### 6.3. GUIアーキテクチャ　クラス構成

主要な2画面（Main Window, 汎用Dialog）のGUIアーキテクチャ　クラス構成を以下に示す。

#### 6.3.1. Main Window

Main Windowのクラス構成は以下の通り。

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊クラス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

XXXXX：  
タイトルバーをカスタマイズするためにWindowChromeを利用したカスタムウィンドウ。

XXXXX：  
変更通知を実現するためのReactivePropertyライブラリ。

#### 6.3.2. 汎用Dialog

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊クラス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

タイトルバーをカスタマイズするためにWindowChromeを利用したカスタムウィンドウ。

XXXXX：  
あｌｋｓｊｆ；あｋｓｊｄｆ；あｋｓｄｊｆ；あｋｄｊｓｆ。

XXXXX：  
Main Windowと同様。

XXXXX：  
Main Windowと同様。

### 6.4. GUIアーキテクチャ　シーケンス

GUIアーキテクチャの主要な処理シーケンス概要を以下に示す。

#### 6.4.1. GUIインスタンス取得時

GUI表示のためにインスタンスを取得する際、DIコンテナでMVVMやその他全ての参照インスタンスの構築が行われた状態のインスタンスを取得する。

＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊シーケンス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

#### 6.4.2. 画面切り替え時



＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊シーケンス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

#### 6.4.3. 設定値表示時



＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊シーケンス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

#### 6.4.4. 設定値変更時



＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊シーケンス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊

#### 6.4.5. 設定値更新時



＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊シーケンス図＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊
